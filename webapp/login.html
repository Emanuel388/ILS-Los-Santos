<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Login – Flashing Light Leitstelle</title>

  <!-- PWA: Manifest & Theme Color -->
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      display: flex;
      height: 100vh;
      align-items: center;
      justify-content: center;
      margin: 0;
    }
    .container {
      background: #fff;
      padding: 2rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 320px;
      border-radius: 4px;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    input, button {
      width: 100%;
      padding: .75rem;
      margin: .5rem 0;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .error {
      color: red;
      margin-top: .5rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Login</h1>
    <input
      type="text"
      id="username"
      placeholder="Benutzername"
      autocomplete="username"
    />
    <input
      type="password"
      id="password"
      placeholder="Passwort"
      autocomplete="current-password"
    />
    <button id="btnLogin">Einloggen</button>
    <div id="error" class="error"></div>
  </div>

  <script>
    document.getElementById("btnLogin").addEventListener("click", async () => {
      const userEl = document.getElementById("username");
      const passEl = document.getElementById("password");
      const errEl  = document.getElementById("error");

      errEl.textContent = "";

      const username = userEl.value.trim();
      const password = passEl.value;

      if (!username || !password) {
        errEl.textContent = "Bitte Benutzername und Passwort eingeben.";
        return;
      }

      try {
        const res  = await fetch("/login", {
          method:      "POST",
          credentials: "include",
          headers:     { "Content-Type": "application/json" },
          body:        JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (!data.success) {
          errEl.textContent = "Login fehlgeschlagen. Bitte prüfen Sie Ihre Daten.";
          return;
        }

        // Weiterleitung nach Rolle
        switch (data.role) {
          case "admin":
            location.href = "/admin.html";
            break;
          case "leitstelle":
            location.href = "/leitstelle.html";
            break;
          default:
            location.href = "/fahrer.html";
            break;
        }
      } catch (e) {
        console.error("Fehler beim Login:", e);
        errEl.textContent = "Serverfehler. Bitte versuchen Sie es später.";
      }
    });

    // ENTER-Taste unterstützt Login
    document.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        document.getElementById("btnLogin").click();
      }
    });

    // PWA: Service Worker registrieren
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(() => console.log('Service Worker registriert'))
        .catch(err => console.error('SW-Fehler:', err));
    }
  </script>
</body>
</html>
